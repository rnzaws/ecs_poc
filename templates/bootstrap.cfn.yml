---
AWSTemplateFormatVersion: '2010-09-09'

# Any code, applications, scripts, templates, proofs of concept,
# documentation and other items are provided for illustration purposes only.
#
# Copyright 2017 Amazon Web Services
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

Resources:

  BootstrapBucket:
    Type: "AWS::S3::Bucket"
    Properties:
      VersioningConfiguration:
        Status: Enabled

  TemplateBucket:
    Type: "AWS::S3::Bucket"
    Properties:
      VersioningConfiguration:
        Status: Enabled

  CloudTrailBucket:
    Type: "AWS::S3::Bucket"
    DeletionPolicy: "Retain"

  CloudTrailBucketPolicy:
    Type: "AWS::S3::BucketPolicy"
    Properties:
      Bucket: !Ref CloudTrailBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: !Sub "aws-cloud-trail-acl-check"
            Effect: "Allow"
            Principal:
              Service: "cloudtrail.amazonaws.com"
            Action: "s3:GetBucketAcl"
            Resource: !GetAtt CloudTrailBucket.Arn
          - Sid: !Sub "aws-cloud-trail-write"
            Effect: "Allow"
            Principal:
              Service: "cloudtrail.amazonaws.com"
            Action: "s3:PutObject"
            Resource: !Sub "arn:aws:s3:::${CloudTrailBucket}/AWSLogs/${AWS::AccountId}/*"
            Condition:
              StringEquals:
                s3:x-amz-acl: "bucket-owner-full-control"
    DependsOn:
      - CloudTrailBucket

  CloudTrailSnsLogNotificationTopic:
    Type: "AWS::SNS::Topic"
    Properties:
      DisplayName: !Sub "${AWS::StackName}-cloud-trail-sns-log-notification-topic"

  CloudTrailLogNotificationTopicPolicy:
    Type: "AWS::SNS::TopicPolicy"
    Properties:
      Topics:
        - !Ref CloudTrailSnsLogNotificationTopic
      PolicyDocument:
        Version: "2008-10-17"
        Statement:
          - Sid: !Sub "aws-cloud-trail-sns-policy"
            Effect: "Allow"
            Principal:
              Service: "cloudtrail.amazonaws.com"
            Resource: !Ref CloudTrailSnsLogNotificationTopic
            Action: "SNS:Publish"
    DependsOn:
      - CloudTrailSnsLogNotificationTopic

  CloudTrail:
    Type: "AWS::CloudTrail::Trail"
    Properties:
      TrailName: !Sub "${AWS::StackName}-cloud-trail"
      S3BucketName: !Ref CloudTrailBucket
      SnsTopicName: !GetAtt CloudTrailSnsLogNotificationTopic.TopicName
      IsLogging: true
      EnableLogFileValidation: true
    DependsOn:
      - CloudTrailBucketPolicy
      - CloudTrailLogNotificationTopicPolicy

Outputs:

  TemplateBucketName:
    Value: !Ref TemplateBucket
    Export:
      Name: !Sub "${AWS::StackName}-template-bucket-name"

  TemplateBucketArn:
    Value: !GetAtt TemplateBucket.Arn
    Export:
      Name: !Sub "${AWS::StackName}-template-bucket-arn"

  BootstrapBucketName:
    Value: !Ref BootstrapBucket
    Export:
      Name: !Sub "${AWS::StackName}-bootstrap-bucket-name"

  BootstrapBucketArn:
    Value: !GetAtt BootstrapBucket.Arn
    Export:
      Name: !Sub "${AWS::StackName}-bootstrap-bucket-arn"

  CloudTrailBucketName:
    Value: !Ref CloudTrailBucket
    Export:
      Name: !Sub "${AWS::StackName}-cloud-trail-bucket-name"

  CloudTrailBucketArn:
    Value: !GetAtt CloudTrailBucket.Arn
    Export:
      Name: !Sub "${AWS::StackName}-cloud-trail-bucket-arn"

  CloudTrailSnsLogNotificationTopicArn:
    Value: !Ref CloudTrailSnsLogNotificationTopic
    Export:
      Name: !Sub "${AWS::StackName}-cloud-trail-sns-log-notification-topic-arn"

  CloudTrailSnsLogNotificationTopicName:
    Value: !GetAtt CloudTrailSnsLogNotificationTopic.TopicName
    Export:
      Name: !Sub "${AWS::StackName}-cloud-trail-sns-log-notification-topic-name"

  CloudTrail:
    Value: !Ref CloudTrail
    Export:
      Name: !Sub "${AWS::StackName}-cloud-trail"

